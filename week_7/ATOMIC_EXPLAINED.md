# üí° Atomic Transaction - –©–æ —Ü–µ?

## üéØ –ü—Ä–æ—Å—Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å

**Atomic** = "all-or-nothing" = "–∞–±–æ –≤—Å–µ, –∞–±–æ –Ω—ñ—á–æ–≥–æ"

```
Commit transaction (atomic!)
         ‚Üì
–û–∑–Ω–∞—á–∞—î: –û–ë–ò –æ–ø–µ—Ä–∞—Ü—ñ—ó –∞–±–æ –≤–∏–∫–æ–Ω–∞–Ω—ñ —Ä–∞–∑–æ–º ‚úÖ
         –∞–±–æ –û–ë–ò —Å–∫–∞—Å–æ–≤–∞–Ω—ñ —Ä–∞–∑–æ–º ‚ùå
         
–ù–µ–º–æ–∂–ª–∏–≤–æ "–Ω–∞–ø–æ–ª–æ–≤–∏–Ω—É"!
```

---

## üìñ –í—ñ–∑—É–∞–ª—å–Ω–æ

### ‚ùå –ë–ï–ó atomic (–Ω–µ–±–µ–∑–ø–µ—á–Ω–æ)

```
1. UPDATE accounts: balance - 100  ‚úÖ
         ‚Üì
   üí• CRASH!
         ‚Üì
2. INSERT INTO outbox              ‚ùå

Result: –ì—Ä–æ—à—ñ –∑–Ω—è—Ç—ñ, –∞–ª–µ event –ù–ï –∑–∞–ø–∏—Å–∞–Ω–∏–π!
        –î–∞–Ω—ñ –ù–ï–ö–û–ù–°–ò–°–¢–ï–ù–¢–ù–Ü! ‚ùå
```

### ‚úÖ –ó atomic (–±–µ–∑–ø–µ—á–Ω–æ)

```
BEGIN TRANSACTION
‚îú‚îÄ 1. UPDATE accounts: balance - 100
‚îú‚îÄ 2. INSERT INTO outbox
‚îî‚îÄ COMMIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
               ‚îÇ
               ‚îú‚îÄ> SUCCESS: –û–ë–ò –∑–±–µ—Ä–µ–∂–µ–Ω—ñ ‚úÖ
               ‚îÇ
               ‚îî‚îÄ> ERROR: –û–ë–ò —Å–∫–∞—Å–æ–≤–∞–Ω—ñ ‚ùå

Result: Consistency –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–∞! ‚úÖ
```

---

## üíª –í –∫–æ–¥—ñ

```go
// BEGIN TRANSACTION
tx, _ := db.Begin()
defer tx.Rollback() // Auto-rollback —è–∫—â–æ –Ω–µ commit

// –û–ø–µ—Ä–∞—Ü—ñ—è 1
tx.Exec("UPDATE accounts SET balance = balance - 100")

// –û–ø–µ—Ä–∞—Ü—ñ—è 2
tx.Exec("INSERT INTO outbox (event) VALUES ('withdrawal')")

// COMMIT (atomic!)
// ‚Üì
// –ê–±–æ –û–ë–ò –∑–±–µ—Ä–µ–∂–µ–Ω—ñ ‚úÖ
// –ê–±–æ –û–ë–ò —Å–∫–∞—Å–æ–≤–∞–Ω—ñ ‚ùå
return tx.Commit()
```

---

## üî¨ –©–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ

### –î–æ COMMIT

```
BEGIN TRANSACTION
         |
–ó–º—ñ–Ω–∏ –≤ "transaction log" (—Ç–∏–º—á–∞—Å–æ–≤–æ)
         |
‚îú‚îÄ balance = 900 (was 1000)
‚îú‚îÄ outbox event created
‚îî‚îÄ –Ü–Ω—à—ñ –ù–ï –ë–ê–ß–ê–¢–¨ —Ü–∏—Ö –∑–º—ñ–Ω (isolation)
```

### COMMIT (—É—Å–ø—ñ—Ö)

```
COMMIT ‚úÖ
  |
Database –∑–∞—Å—Ç–æ—Å–æ–≤—É—î –í–°–Ü –∑–º—ñ–Ω–∏:
‚îú‚îÄ balance = 900 ‚úÖ
‚îú‚îÄ outbox event ‚úÖ
‚îî‚îÄ –ó–º—ñ–Ω–∏ —Å—Ç–∞—é—Ç—å –≤–∏–¥–∏–º–∏–º–∏ –≤—Å—ñ–º
```

### ROLLBACK (–ø–æ–º–∏–ª–∫–∞)

```
ERROR ‚ùå
  |
Database —Å–∫–∞—Å–æ–≤—É—î –í–°–Ü –∑–º—ñ–Ω–∏:
‚îú‚îÄ balance = 1000 (—è–∫ –±—É–ª–æ) ‚úÖ
‚îú‚îÄ outbox event –ù–ï —Å—Ç–≤–æ—Ä–µ–Ω–∏–π ‚úÖ
‚îî‚îÄ –Ø–∫ –Ω—ñ–±–∏ –Ω—ñ—á–æ–≥–æ –Ω–µ –≤—ñ–¥–±—É–ª–æ—Å—è
```

---

## üéì ACID Properties

**Atomic** - —Ü–µ "A" –≤ ACID:

```
A - Atomic        ‚Üí All-or-nothing ‚úÖ
C - Consistent    ‚Üí –î–∞–Ω—ñ –≤–∞–ª—ñ–¥–Ω—ñ ‚úÖ
I - Isolated      ‚Üí –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –Ω–µ –∑–∞–≤–∞–∂–∞—é—Ç—å ‚úÖ
D - Durable       ‚Üí –ü—ñ—Å–ª—è COMMIT - –Ω–∞–∑–∞–≤–∂–¥–∏ ‚úÖ
```

---

## üè¶ –ü—Ä–∏–∫–ª–∞–¥: –ü–µ—Ä–µ–∫–∞–∑ –≥—Ä–æ—à–µ–π

```go
tx, _ := db.Begin()
defer tx.Rollback()

// –û–ø–µ—Ä–∞—Ü—ñ—è 1: –ó–Ω—è—Ç–∏ –∑ —Ä–∞—Ö—É–Ω–∫—É A
tx.Exec("UPDATE accounts SET balance = balance - 100 WHERE id = 1")

// –û–ø–µ—Ä–∞—Ü—ñ—è 2: –î–æ–¥–∞—Ç–∏ –Ω–∞ —Ä–∞—Ö—É–Ω–æ–∫ B
tx.Exec("UPDATE accounts SET balance = balance + 100 WHERE id = 2")

// ATOMIC: –∞–±–æ –û–ë–ò –≤–∏–∫–æ–Ω–∞–Ω—ñ, –∞–±–æ –ñ–û–î–ù–ê!
tx.Commit()
```

**–ë–µ–∑ atomic:**
```
‚ùå –ì—Ä–æ—à—ñ –∑–Ω—è—Ç—ñ –∑ A, –∞–ª–µ –ù–ï –¥–æ–¥–∞–Ω—ñ –Ω–∞ B = –≥—Ä–æ—à—ñ –∑–Ω–∏–∫–ª–∏!
```

**–ó atomic:**
```
‚úÖ –ê–±–æ –æ–±–∏–¥–≤—ñ —É—Å–ø—ñ—à–Ω—ñ
‚úÖ –ê–±–æ –æ–±–∏–¥–≤—ñ —Å–∫–∞—Å–æ–≤–∞–Ω—ñ
‚úÖ –ì—Ä–æ—à—ñ –Ω–µ –º–æ–∂—É—Ç—å "–∑–Ω–∏–∫–Ω—É—Ç–∏"
```

---

## ‚ö†Ô∏è –ü–æ—à–∏—Ä–µ–Ω—ñ –ø–æ–º–∏–ª–∫–∏

### –ü–æ–º–∏–ª–∫–∞ 1: –ó–∞–±—É–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ tx

```go
tx, _ := db.Begin()

// ‚ùå BAD - –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–≤ db –∑–∞–º—ñ—Å—Ç—å tx
db.Exec("UPDATE accounts ...")

// ‚úÖ GOOD
tx.Exec("UPDATE accounts ...")
```

### –ü–æ–º–∏–ª–∫–∞ 2: –ó–∞–±—É–≤ defer Rollback

```go
// ‚ùå BAD
tx, _ := db.Begin()
tx.Exec("UPDATE ...")
tx.Commit()

// ‚úÖ GOOD - –∑–∞–≤–∂–¥–∏ –¥–æ–¥–∞–≤–∞–π defer
tx, _ := db.Begin()
defer tx.Rollback() // ‚úÖ –ë–µ–∑–ø–µ—á–Ω–æ
tx.Exec("UPDATE ...")
tx.Commit()
```

### –ü–æ–º–∏–ª–∫–∞ 3: –î–æ–≤–≥—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó

```go
// ‚ùå BAD - I/O –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
tx, _ := db.Begin()
tx.Exec("UPDATE ...")
time.Sleep(5 * time.Second) // ‚ùå
http.Get("https://api.com") // ‚ùå
tx.Commit()

// ‚úÖ GOOD - —à–≤–∏–¥–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è
tx, _ := db.Begin()
tx.Exec("UPDATE ...")
tx.Exec("INSERT ...")
tx.Commit() // < 100ms
```

---

## üìä Trade-off

### Performance

```
Non-Atomic: 20ms ‚ö°
Atomic:     26ms üê¢ (–Ω–∞ 30% –ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ)

–ê–ª–µ Atomic = Consistency guaranteed! ‚úÖ
```

### –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏?

‚úÖ **–û–±–æ–≤'—è–∑–∫–æ–≤–æ:**
- –§—ñ–Ω–∞–Ω—Å–æ–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó
- –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è
- –Ü–Ω–≤–µ–Ω—Ç–∞—Ä

‚ö†Ô∏è **–ù–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ:**
- Logs
- Analytics
- Cache

---

## üéØ Key Takeaways

1. **Atomic = All-or-Nothing**
   - –ê–±–æ –≤—Å—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó ‚úÖ
   - –ê–±–æ –∂–æ–¥–Ω–∞ ‚ùå

2. **BEGIN ‚Üí –æ–ø–µ—Ä–∞—Ü—ñ—ó ‚Üí COMMIT**
   - COMMIT = –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –í–°–Ü –∑–º—ñ–Ω–∏
   - ROLLBACK = —Å–∫–∞—Å—É–≤–∞—Ç–∏ –í–°–Ü –∑–º—ñ–Ω–∏

3. **Consistency –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–∞**
   - –î–∞–Ω—ñ –Ω—ñ–∫–æ–ª–∏ –Ω–µ –≤ "–ø—Ä–æ–º—ñ–∂–Ω–æ–º—É" —Å—Ç–∞–Ω—ñ
   - Constraints –∑–∞–≤–∂–¥–∏ –≤–∏–∫–æ–Ω–∞–Ω—ñ

4. **–ó–∞–≤–∂–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π defer tx.Rollback()**
   - –ë–µ–∑–ø–µ–∫–∞ –≤—ñ–¥ panics
   - Auto-cleanup

---

## üìñ –ß–∏—Ç–∞—Ç–∏ –ø–æ–≤–Ω–∏–π —Ñ–∞–π–ª

```bash
cd /Users/vkuzm/GolandProjects/golang_practice/week_7

cat theory/13_atomic_transactions.md
```

---

**Atomic = Consistency = Foundation –¥–ª—è –Ω–∞–¥—ñ–π–Ω–∏—Ö —Å–∏—Å—Ç–µ–º!** ‚úÖüéØ

**–§–∞–π–ª:** `theory/13_atomic_transactions.md`  
**–û–±—Å—è–≥:** –î–µ—Ç–∞–ª—å–Ω—ñ –ø–æ—è—Å–Ω–µ–Ω–Ω—è + –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó + –ø—Ä–∏–∫–ª–∞–¥–∏ –∫–æ–¥—É
